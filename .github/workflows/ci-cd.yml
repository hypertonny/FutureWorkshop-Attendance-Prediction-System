name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Job 1: Lint & Syntax Check ──
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check syntax (all .py files)
        run: python -m py_compile app.py main.py generate_data.py src/database.py src/feature_engineering.py src/train_model.py src/predict.py src/retrain.py

  # ── Job 2: Train & Test Pipeline ──
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run full pipeline (generate → train → predict)
        run: |
          echo "── Step 1: Generate data & train models ──"
          python main.py

          echo ""
          echo "── Step 2: Verify prediction works ──"
          python src/predict.py

          echo ""
          echo "── Step 3: Verify retrain pipeline ──"
          python src/retrain.py --force

      - name: Verify model artifacts exist
        run: |
          echo "Checking model files..."
          test -f models/xgboost_latest.pkl && echo "✓ XGBoost model"
          test -f models/random_forest_latest.pkl && echo "✓ Random Forest model"
          test -f models/logistic_regression_latest.pkl && echo "✓ Logistic Regression model"
          test -f models/model_comparison.json && echo "✓ Model comparison"
          test -f models/feature_importance.csv && echo "✓ Feature importance"
          test -f master_dataset.csv && echo "✓ Dataset generated"
          echo "All artifacts verified ✓"

  # ── Job 3: Docker Build Check ──
  docker:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t futureworkshop-predictor .

      - name: Verify container starts
        run: |
          docker run -d --name test-app -p 10000:10000 futureworkshop-predictor
          echo "Waiting for Streamlit to start..."
          sleep 15
          curl -f http://localhost:10000/_stcore/health || (docker logs test-app && exit 1)
          echo "Container health check passed ✓"
          docker stop test-app

  # ── Job 4: Deploy notification ──
  deploy:
    runs-on: ubuntu-latest
    needs: [lint, test, docker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy triggered
        run: |
          echo "═══════════════════════════════════════════"
          echo "  All checks passed — deploying to Render"
          echo "  Render auto-deploys from main branch"
          echo "  URL: https://model-testing.bnhverse.tech"
          echo "═══════════════════════════════════════════"
